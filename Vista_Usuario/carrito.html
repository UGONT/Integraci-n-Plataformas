<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Carrito - FerreMax</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <header class="header-custom">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center py-3">
        <div class="d-flex align-items-center">
          <img src="../imagenes/FerreMax.png" alt="Logo Ferremax" class="logo-img me-3" />
        </div>
        <a href="../index.html" class="btn btn-outline-primary">
          <i class="fas fa-arrow-left me-2"></i> Volver
        </a>
      </div>
    </div>
  </header>
  <div class="container my-5">
    <h2 class="mb-4">Tu Carrito</h2>

    <div id="carrito-vacio" class="alert alert-info d-none">Tu carrito está vacío.</div>

    <table class="table table-bordered d-none" id="tabla-carrito">
      <thead class="table-light">
        <tr>
          <th>Producto</th>
          <th>Precio</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="contenido-carrito"></tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="text-end"><strong>Total:</strong></td>
          <td colspan="2" id="total-carrito"></td>
        </tr>
      </tfoot>
    </table>

    <div class="d-flex justify-content-between mt-4">
      <a href="../index.html" class="btn btn-outline-secondary">← Seguir comprando</a>
      <button class="btn btn-success" onclick="finalizarCompra()">Finalizar compra</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      mostrarCarrito();
    });

    function mostrarCarrito() {
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
      const tabla = document.getElementById("tabla-carrito");
      const vacio = document.getElementById("carrito-vacio");
      const cuerpo = document.getElementById("contenido-carrito");
      const total = document.getElementById("total-carrito");

      if (!carrito.length) {
        tabla.classList.add("d-none");
        vacio.classList.remove("d-none");
        return;
      }

      cuerpo.innerHTML = "";
      let totalFinal = 0;

      carrito.forEach((item, i) => {
        const subtotal = item.precio * item.cantidad;
        totalFinal += subtotal;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.nombre}</td>
          <td>$${item.precio}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="cambiarCantidad(${i}, -1)">-</button>
            ${item.cantidad}
            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="cambiarCantidad(${i}, 1)">+</button>
          </td>
          <td>$${subtotal}</td>
          <td><button class="btn btn-sm btn-danger" onclick="eliminarProducto(${i})">Eliminar</button></td>
        `;
        cuerpo.appendChild(row);
      });

      total.textContent = `$${totalFinal}`;
      tabla.classList.remove("d-none");
      vacio.classList.add("d-none");
    }

    function cambiarCantidad(index, cambio) {
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
      if (!carrito[index]) return;

      carrito[index].cantidad += cambio;
      if (carrito[index].cantidad <= 0) {
        carrito.splice(index, 1);
      }

      localStorage.setItem("carrito", JSON.stringify(carrito));
      mostrarCarrito();
    }

    function eliminarProducto(index) {
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
      carrito.splice(index, 1);
      localStorage.setItem("carrito", JSON.stringify(carrito));
      mostrarCarrito();
    }

    async function finalizarCompra() {
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];

      if (!carrito.length) {
        alert("Tu carrito está vacío.");
        return;
      }

      // Calcular total
      const total = carrito.reduce((sum, prod) => sum + prod.precio * prod.cantidad, 0);

      // Preparar datos para la transacción
      const payload = {
        buy_order: "orden_" + Date.now(),
        session_id: "session_" + Math.floor(Math.random() * 100000),
        amount: total,
        return_url: "https://main.d1vfnea5ey4oxp.amplifyapp.com/index.html" 
      };

      try {
        const response = await fetch("https://21v54ti4n0.execute-api.us-east-1.amazonaws.com/test/generarTransaccion", { 
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.token && data.url) {
          redirigirAPagoWebpay(data.url, data.token);
          localStorage.removeItem("carrito");
        } else {
          alert("Error al generar la transacción.");
        }
      } catch (error) {
        console.error("Error al iniciar pago:", error);
        alert("Ocurrió un error al procesar la compra.");
      }
    }

    // Redireccionamiento POST a Webpay
    function redirigirAPagoWebpay(url, token) {
      const form = document.createElement("form");
      form.method = "POST";
      form.action = url;

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "token_ws";
      input.value = token;

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
  </script>
</body>

</html>